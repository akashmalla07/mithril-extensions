<html>
<head>
    <title></title>
    <script src="examples/mithril.js"></script>
    <script src="../mithril.bindings/mithril.bindings.js"></script>
    <script src="../mithril.sugartags/mithril.sugartags.js"></script>
    <script src="../mithril.templates/mithril.templates.js"></script>
</head>
<body>

<div id="content"></div>

<script>
var autocompleter = {
    model: function(){
        this.value = m.p("");
        this.data = m.p([]);
    },
    controller: function(data, getter) {
        this.getter = getter;
        var model = this.model = new autocompleter.model();

        //  When the value changes, update the list
        model.value.subscribe(function(value){
            var list = value === "" ? 
                []: 
                data.filter(function(item) {
                    return getter(item)
                        .toLowerCase()
                        .indexOf(value.toLowerCase()) > -1;
                }, this);
            model.data(list);
        });

        //  Changes the list depending on input
        this.change = function(value) {
            this.model.value(value);

            var list = value === "" ? 
                []: 
                data.filter(function(item) {
                    return this.getter(item)
                        .toLowerCase()
                        .indexOf(value.toLowerCase()) > -1;
                }, this);
            this.model.data(list);
        };

        //  When an option is selected
        this.select = function(value) {
            this.model.value(value);
            this.model.data([]);
            if (this.onchange) {
                this.onchange({
                    currentTarget: {
                        value: value
                    }
                });
            }
        };
    },

    view: function(ctrl, options) {
        if (options) ctrl.onchange = options.onchange;
        with(m.sugarTags){
            return [
                // INPUT({
                //     oninput: m.withAttr("value", ctrl.change.bind(ctrl)), 
                //     value: ctrl.model.value()
                // }),
                INPUT({valueInput: ctrl.model.value}),
                ctrl.model.data().map(function(item) {
                    return DIV({
                        data: ctrl.getter(item), 
                        onclick: m.withAttr("data", ctrl.select.bind(ctrl))
                    },
                    ctrl.getter(item)
                    );
                })
            ];
        }
    }

};



//here's an example of using the autocompleter
var dashboard = {}

dashboard.controller = function() {
    this.names = m.p([
        {id: 1, name: "John"},
        {id: 2, name: "Bob"},
        {id: 2, name: "Mary"}
    ]);
    
    var x = this.names();

    console.log(x);

    this.autocompleter = new autocompleter.controller(x, function(item) {
        return item.name;
    });
};

dashboard.view = function(ctrl) {
    return m("#example", [
        new autocompleter.view(ctrl.autocompleter, {onchange: m.withAttr("value", console.log)}),
    ]);
};



//initialize
m.module(document.getElementById('content'), dashboard);

</script>

</body>
</html>
